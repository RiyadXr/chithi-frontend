<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>চিঠি - কথা বলুন নিশ্চিন্তে, চিঠিতে নিরাপদে</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Your existing CSS styles remain exactly the same */
        /* ... (all the CSS from your original code) ... */
        
        /* Add this new CSS for statistics */
        .stats-container {
            background: var(--bg-secondary);
            border-radius: var(--border-radius-sm);
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .stat-item {
            text-align: center;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .last-updated {
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <!-- Your existing HTML structure remains exactly the same -->
    <!-- ... (all the HTML from your original code) ... -->

    <!-- Add statistics section to settings modal -->
    <!-- In your settings modal, add this after the "Current PIN" section: -->
    
    <!--
    <div class="setting-section">
        <h3 class="setting-title">App Statistics</h3>
        <div class="stats-container">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="statRooms">0</div>
                    <div class="stat-label">Total Rooms</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statUsers">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statMessages">0</div>
                    <div class="stat-label">Total Messages</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statActive">0</div>
                    <div class="stat-label">Active Rooms</div>
                </div>
            </div>
            <div class="last-updated">
                Last updated: <span id="lastUpdated">Never</span>
            </div>
        </div>
    </div>
    -->

    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        // DOM Elements
        const welcomeScreen = document.getElementById('welcomeScreen');
        const joinScreen = document.getElementById('joinScreen');
        const chatScreen = document.getElementById('chatScreen');
        const startChatBtn = document.getElementById('startChatBtn');
        const clearPinBtn = document.getElementById('clearPinBtn');
        const joinChatBtn = document.getElementById('joinChatBtn');
        const helpBtn = document.getElementById('helpBtn');
        const userNameInput = document.getElementById('userNameInput');
        const pinInputs = document.querySelectorAll('.pin-input');
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const status = document.getElementById('status');
        const userCount = document.getElementById('userCount');
        const userCountText = document.getElementById('userCountText');
        const connectionStatus = document.getElementById('connectionStatus');
        const typingIndicator = document.getElementById('typingIndicator');
        const typingUser = document.getElementById('typingUser');
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPicker = document.getElementById('emojiPicker');
        const settingsBtn = document.getElementById('settingsBtn');
        const leaveChatBtn = document.getElementById('leaveChatBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const helpModal = document.getElementById('helpModal');
        const closeHelpBtn = document.getElementById('closeHelpBtn');
        const closeHelpBtn2 = document.getElementById('closeHelpBtn2');
        const themeOptions = document.querySelectorAll('.theme-option');
        const deleteRoomBtn = document.getElementById('deleteRoomBtn');
        const leaveRoomBtn = document.getElementById('leaveRoomBtn');
        const currentPinDisplay = document.getElementById('currentPinDisplay');
        const userList = document.getElementById('userList');
        const contextMenu = document.getElementById('contextMenu');
        const contextReplyBtn = document.getElementById('contextReplyBtn');
        const contextUnsendBtn = document.getElementById('contextUnsendBtn');
        const contextCopyBtn = document.getElementById('contextCopyBtn');
        const replyPreview = document.getElementById('replyPreview');
        const replyPreviewSender = document.getElementById('replyPreviewSender');
        const replyPreviewText = document.getElementById('replyPreviewText');
        const cancelReplyBtn = document.getElementById('cancelReplyBtn');

        // Statistics elements (if you added them)
        const statRooms = document.getElementById('statRooms');
        const statUsers = document.getElementById('statUsers');
        const statMessages = document.getElementById('statMessages');
        const statActive = document.getElementById('statActive');
        const lastUpdated = document.getElementById('lastUpdated');

        // Socket.io connection - Use your Render backend URL
        const BACKEND_URL = 'https://chithi-backend.onrender.com'; // Replace with your actual backend URL
        const socket = io(BACKEND_URL, {
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000
        });

        // App state
        let currentPin = '';
        let currentUserName = '';
        let isTyping = false;
        let typingTimer;
        let currentTheme = 'default';
        let chatHistory = [];
        let currentUsers = [];
        let currentReply = null;
        let messageStatus = new Map();

        // Popular emojis for the picker
        const emojis = ['😀', '😂', '🥰', '😎', '😍', '🤔', '👍', '❤️', '🔥', '🎉', '🙏', '💯', '👋', '🤝', '🙌', '👏', '🤗', '😊', '🤩', '😜', '🤪', '😇', '🥳', '😭', '😡', '🥺', '😱', '🤯', '😴', '💀', '👻', '💩', '🤡', '👀', '🎃', '💔', '💪', '🧠', '👑', '💎', '⭐', '🌈', '🍕', '🍦', '⚽', '🎮', '🚀', '💻', '📱', '🎵', '🎨', '💰', '🕶️', '🎁'];

        // Initialize the app
        function init() {
            setupEventListeners();
            renderEmojiPicker();
            setupMessageInput();
            loadTheme();
            checkForExistingSession();
        }

        // Check if user was already in a chat session
        function checkForExistingSession() {
            const savedPin = localStorage.getItem('chithi-pin');
            const savedUsername = localStorage.getItem('chithi-username');
            const savedHistory = localStorage.getItem(`chithi-history-${savedPin}`);
            
            if (savedPin && savedUsername) {
                // Auto-join the previous chat
                currentPin = savedPin;
                currentUserName = savedUsername;
                
                // Load chat history if available
                if (savedHistory) {
                    chatHistory = JSON.parse(savedHistory);
                    renderChatHistory();
                }
                
                // Show chat screen and join room
                welcomeScreen.classList.add('hidden');
                joinScreen.classList.add('hidden');
                chatScreen.classList.remove('hidden');
                settingsBtn.classList.remove('hidden');
                leaveChatBtn.classList.remove('hidden');
                connectionStatus.classList.remove('hidden');
                
                // Update PIN display
                currentPinDisplay.textContent = currentPin;
                
                // Join the room
                socket.emit('join_room', { 
                    pin: currentPin,
                    userName: currentUserName
                });
                
                // Focus on message input
                messageInput.focus();
            }
        }

        // Set up all event listeners
        function setupEventListeners() {
            startChatBtn.addEventListener('click', showJoinScreen);
            clearPinBtn.addEventListener('click', clearPin);
            joinChatBtn.addEventListener('click', joinChat);
            helpBtn.addEventListener('click', showHelp);
            closeHelpBtn.addEventListener('click', hideHelp);
            closeHelpBtn2.addEventListener('click', hideHelp);
            sendBtn.addEventListener('click', sendMessage);
            emojiBtn.addEventListener('click', toggleEmojiPicker);
            settingsBtn.addEventListener('click', showSettings);
            leaveChatBtn.addEventListener('click', showLeaveConfirm);
            closeSettingsBtn.addEventListener('click', hideSettings);
            deleteRoomBtn.addEventListener('click', deleteRoom);
            leaveRoomBtn.addEventListener('click', leaveRoom);
            cancelReplyBtn.addEventListener('click', cancelReply);
            contextReplyBtn.addEventListener('click', handleContextReply);
            contextUnsendBtn.addEventListener('click', handleContextUnsend);
            contextCopyBtn.addEventListener('click', handleContextCopy);
            
            // Theme selection
            themeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const theme = this.getAttribute('data-theme');
                    changeTheme(theme);
                });
            });
            
            messageInput.addEventListener('input', function() {
                handleTyping();
                autoResizeTextarea(this);
            });
            
            // Enter key to send message
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Pin input handling
            pinInputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value.length === 1 && index < pinInputs.length - 1) {
                        pinInputs[index + 1].focus();
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && index > 0 && e.target.value === '') {
                        pinInputs[index - 1].focus();
                    }
                });
            });

            // Close context menu when clicking elsewhere
            document.addEventListener('click', (e) => {
                if (!contextMenu.contains(e.target)) {
                    contextMenu.classList.remove('show');
                }
            });

            // Socket event handlers
            socket.on('connect', handleSocketConnect);
            socket.on('disconnect', handleSocketDisconnect);
            socket.on('reconnecting', handleSocketReconnecting);
            socket.on('user_joined', handleUserJoined);
            socket.on('user_left', handleUserLeft);
            socket.on('message', handleNewMessage);
            socket.on('typing_start', handleTypingStart);
            socket.on('typing_stop', handleTypingStop);
            socket.on('message_reaction', handleMessageReaction);
            socket.on('theme_changed', handleThemeChanged);
            socket.on('room_deleted', handleRoomDeleted);
            socket.on('user_count_update', handleUserCountUpdate);
            socket.on('current_users', handleCurrentUsers);
            socket.on('message_status_update', handleMessageStatusUpdate);
            socket.on('message_unsent', handleMessageUnsent);
            socket.on('chat_history', handleChatHistory);
        }

        // Socket event handlers
        function handleSocketConnect() {
            status.className = 'status online';
            console.log('Connected to server');
            
            // Rejoin room if we were in one
            if (currentPin && currentUserName) {
                socket.emit('join_room', { 
                    pin: currentPin,
                    userName: currentUserName
                });
            }
        }

        function handleSocketDisconnect() {
            status.className = 'status offline';
            console.log('Disconnected from server');
        }

        function handleSocketReconnecting() {
            status.className = 'status connecting';
            console.log('Reconnecting to server...');
        }

        function handleUserJoined(data) {
            addSystemMessage(`${data.userName} joined the chat`);
            connectionStatus.classList.add('hidden');
        }

        function handleUserLeft(data) {
            addSystemMessage(`${data.userName} left the chat`);
        }

        function handleNewMessage(data) {
            addMessage(data.message, data.sender, data.timestamp, 'received', data.messageId, data.replyTo);
            saveMessageToHistory(data.message, data.sender, data.timestamp, 'received', data.messageId, data.replyTo);
            
            // Update message status for sender
            socket.emit('message_delivered', {
                pin: currentPin,
                messageId: data.messageId
            });
        }

        function handleChatHistory(data) {
            // If we receive chat history from server, use it
            if (data.messages && data.messages.length > 0) {
                // Clear current messages except the welcome message
                const welcomeMessage = chatContainer.querySelector('.message:first-child');
                chatContainer.innerHTML = '';
                if (welcomeMessage) {
                    chatContainer.appendChild(welcomeMessage);
                }
                
                // Add all messages from server history
                data.messages.forEach(msg => {
                    addMessage(msg.message, msg.sender, msg.timestamp, msg.type, msg.messageId, msg.replyTo);
                });
                
                // Update local chat history
                chatHistory = data.messages;
                
                console.log(`Loaded ${data.messages.length} messages from server history`);
            }
        }

        function handleTypingStart(data) {
            typingUser.textContent = `${data.userName} is typing`;
            typingIndicator.classList.remove('hidden');
        }

        function handleTypingStop() {
            typingIndicator.classList.add('hidden');
        }

        function handleMessageReaction(data) {
            updateMessageReaction(data.messageId, data.reaction, data.count);
        }

        function handleThemeChanged(data) {
            changeTheme(data.theme, false);
        }

        function handleRoomDeleted() {
            addSystemMessage('Room has been deleted. Chat history will be cleared.');
            // Clear local storage for this room
            localStorage.removeItem(`chithi-history-${currentPin}`);
            // Reset the UI after a delay
            setTimeout(() => {
                resetChat();
            }, 3000);
        }

        function handleUserCountUpdate(data) {
            userCountText.textContent = data.count;
            if (data.count > 1) {
                userCount.classList.remove('hidden');
            } else {
                userCount.classList.add('hidden');
            }
        }

        function handleCurrentUsers(data) {
            currentUsers = data.users;
            updateUserList();
        }

        function handleMessageStatusUpdate(data) {
            messageStatus.set(data.messageId, data.status);
            updateMessageStatus(data.messageId, data.status);
        }

        function handleMessageUnsent(data) {
            const messageElement = document.querySelector(`[data-message-id="${data.messageId}"]`);
            if (messageElement) {
                messageElement.remove();
                
                // Remove from chat history
                chatHistory = chatHistory.filter(msg => msg.messageId !== data.messageId);
                localStorage.setItem(`chithi-history-${currentPin}`, JSON.stringify(chatHistory));
            }
        }

        function updateUserList() {
            userList.innerHTML = '';
            
            currentUsers.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                
                // Get first letter for avatar
                const firstLetter = user.userName.charAt(0).toUpperCase();
                
                userItem.innerHTML = `
                    <div class="user-avatar">${firstLetter}</div>
                    <div class="user-name">${user.userName}</div>
                `;
                
                userList.appendChild(userItem);
            });
        }

        // Load app statistics
        async function loadAppStatistics() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/stats`);
                if (response.ok) {
                    const stats = await response.json();
                    updateStatisticsDisplay(stats);
                }
            } catch (error) {
                console.log('Could not load statistics:', error);
            }
        }

        function updateStatisticsDisplay(stats) {
            if (statRooms && statUsers && statMessages && statActive && lastUpdated) {
                statRooms.textContent = stats.totalRooms;
                statUsers.textContent = stats.totalUsers;
                statMessages.textContent = stats.totalMessages;
                statActive.textContent = stats.activeRooms;
                
                const lastUpdatedDate = new Date(stats.lastUpdated);
                lastUpdated.textContent = lastUpdatedDate.toLocaleString();
            }
        }

        // UI Functions
        function showJoinScreen() {
            welcomeScreen.classList.add('hidden');
            joinScreen.classList.remove('hidden');
            userNameInput.focus();
        }

        function clearPin() {
            pinInputs.forEach(input => {
                input.value = '';
            });
            pinInputs[0].focus();
        }

        function showHelp() {
            helpModal.classList.add('active');
        }

        function hideHelp() {
            helpModal.classList.remove('active');
        }

        function joinChat() {
            currentUserName = userNameInput.value.trim();
            currentPin = '';
            pinInputs.forEach(input => {
                currentPin += input.value;
            });
            
            if (currentUserName === '') {
                alert('Please enter your name');
                return;
            }
            
            if (currentPin.length !== 4) {
                alert('Please enter a 4-digit PIN');
                return;
            }
            
            // Save user session
            localStorage.setItem('chithi-pin', currentPin);
            localStorage.setItem('chithi-username', currentUserName);
            
            // Load existing chat history if available
            const savedHistory = localStorage.getItem(`chithi-history-${currentPin}`);
            if (savedHistory) {
                chatHistory = JSON.parse(savedHistory);
                renderChatHistory();
            }
            
            joinScreen.classList.add('hidden');
            chatScreen.classList.remove('hidden');
            settingsBtn.classList.remove('hidden');
            leaveChatBtn.classList.remove('hidden');
            connectionStatus.classList.remove('hidden');
            
            // Update PIN display in settings
            currentPinDisplay.textContent = currentPin;
            
            // Join the room with the PIN and user name
            socket.emit('join_room', { 
                pin: currentPin,
                userName: currentUserName
            });
            
            // Focus on message input
            messageInput.focus();
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            if (message === '') return;
            
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const messageId = generateMessageId();
            
            // Add message to UI
            addMessage(message, currentUserName, timestamp, 'sent', messageId, currentReply);
            
            // Save message to history
            saveMessageToHistory(message, currentUserName, timestamp, 'sent', messageId, currentReply);
            
            // Send message via socket
            const messageData = {
                pin: currentPin,
                message: message,
                timestamp: timestamp,
                messageId: messageId,
                sender: currentUserName
            };
            
            if (currentReply) {
                messageData.replyTo = currentReply;
            }
            
            socket.emit('send_message', messageData);
            
            // Set initial status as sent (single tick)
            messageStatus.set(messageId, 'sent');
            updateMessageStatus(messageId, 'sent');
            
            // Clear input and reply
            messageInput.value = '';
            autoResizeTextarea(messageInput);
            cancelReply();
            
            // Stop typing indicator
            socket.emit('typing_stop', { 
                pin: currentPin,
                userName: currentUserName
            });
            isTyping = false;
        }

        function addMessage(text, sender, timestamp, type, messageId, replyTo = null) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.setAttribute('data-message-id', messageId);
            
            // Add context menu on right-click/long press
            messageEl.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showContextMenu(e, messageId, sender === currentUserName);
            });
            
            // Add long press on touch devices
            let pressTimer;
            messageEl.addEventListener('touchstart', (e) => {
                pressTimer = setTimeout(() => {
                    showContextMenu(e.touches[0], messageId, sender === currentUserName);
                }, 500);
            });
            
            messageEl.addEventListener('touchend', () => {
                clearTimeout(pressTimer);
            });
            
            let messageContent = '';
            
            // Add reply preview if this is a reply
            if (replyTo) {
                messageContent += `
                    <div class="message-reply" data-original-message-id="${replyTo.messageId}">
                        <div class="reply-sender">${replyTo.sender}</div>
                        <div class="reply-text">${replyTo.text}</div>
                    </div>
                `;
            }
            
            messageContent += `
                <div class="message-header">
                    <span class="message-sender">${sender}</span>
                </div>
                <div class="message-text">${text}</div>
                <div class="message-time">
                    ${timestamp}
                    ${type === 'sent' ? '<div class="message-status status-single-tick"><i class="fas fa-check"></i></div>' : ''}
                </div>
                <div class="message-actions">
                    <button class="reaction-btn" data-reaction="👍">👍</button>
                    <button class="reaction-btn" data-reaction="❤️">❤️</button>
                    <button class="reaction-btn" data-reaction="😂">😂</button>
                    <button class="reaction-btn" data-reaction="😮">😮</button>
                </div>
                <div class="reactions-container" id="reactions-${messageId}"></div>
            `;
            
            messageEl.innerHTML = messageContent;
            
            // Add event listeners to reaction buttons
            const reactionBtns = messageEl.querySelectorAll('.reaction-btn');
            reactionBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const reaction = this.getAttribute('data-reaction');
                    socket.emit('message_reaction', {
                        pin: currentPin,
                        messageId: messageId,
                        reaction: reaction
                    });
                });
            });
            
            // Add click event to reply preview to scroll to original message
            const replyElement = messageEl.querySelector('.message-reply');
            if (replyElement) {
                replyElement.addEventListener('click', function() {
                    const originalMessageId = this.getAttribute('data-original-message-id');
                    const originalMessage = document.querySelector(`[data-message-id="${originalMessageId}"]`);
                    if (originalMessage) {
                        originalMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        originalMessage.style.backgroundColor = 'rgba(124, 58, 237, 0.1)';
                        setTimeout(() => {
                            originalMessage.style.backgroundColor = '';
                        }, 2000);
                    }
                });
            }
            
            chatContainer.appendChild(messageEl);
            scrollToBottom();
            
            // Update status if available
            if (messageStatus.has(messageId)) {
                updateMessageStatus(messageId, messageStatus.get(messageId));
            }
        }

        function saveMessageToHistory(text, sender, timestamp, type, messageId, replyTo = null) {
            chatHistory.push({
                text, sender, timestamp, type, messageId, replyTo
            });
            
            // Save to localStorage (limit to 100 messages to prevent storage issues)
            if (chatHistory.length > 100) {
                chatHistory = chatHistory.slice(-100);
            }
            
            localStorage.setItem(`chithi-history-${currentPin}`, JSON.stringify(chatHistory));
        }

        function renderChatHistory() {
            // Clear current messages except the welcome message
            const welcomeMessage = chatContainer.querySelector('.message:first-child');
            chatContainer.innerHTML = '';
            if (welcomeMessage) {
                chatContainer.appendChild(welcomeMessage);
            }
            
            // Add all messages from history
            chatHistory.forEach(msg => {
                addMessage(msg.text, msg.sender, msg.timestamp, msg.type, msg.messageId, msg.replyTo);
            });
        }

        function scrollToBottom() {
            // Scroll to bottom of chat container
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function updateMessageReaction(messageId, reaction, count = 1) {
            const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageEl) return;
            
            const reactionsContainer = messageEl.querySelector('.reactions-container');
            const existingReaction = reactionsContainer.querySelector(`[data-reaction="${reaction}"]`);
            
            if (existingReaction) {
                const countEl = existingReaction.querySelector('.reaction-count');
                countEl.textContent = count;
            } else {
                const reactionEl = document.createElement('div');
                reactionEl.className = 'reaction';
                reactionEl.setAttribute('data-reaction', reaction);
                reactionEl.innerHTML = `
                    <span>${reaction}</span>
                    <span class="reaction-count">${count}</span>
                `;
                reactionsContainer.appendChild(reactionEl);
            }
        }

        function updateMessageStatus(messageId, status) {
            const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageEl) {
                const statusElement = messageEl.querySelector('.message-status');
                if (statusElement) {
                    if (status === 'sent') {
                        statusElement.className = 'message-status status-single-tick';
                        statusElement.innerHTML = '<i class="fas fa-check"></i>';
                    } else if (status === 'delivered') {
                        statusElement.className = 'message-status status-double-tick';
                        statusElement.innerHTML = '<i class="fas fa-check"></i><i class="fas fa-check"></i>';
                    } else if (status === 'seen') {
                        statusElement.className = 'message-status status-triple-tick';
                        statusElement.innerHTML = '<i class="fas fa-check"></i><i class="fas fa-check"></i><i class="fas fa-check"></i>';
                    }
                }
            }
        }

        function addSystemMessage(text) {
            const messageEl = document.createElement('div');
            messageEl.className = 'message received';
            messageEl.style.alignSelf = 'center';
            messageEl.style.backgroundColor = 'transparent';
            messageEl.style.border = 'none';
            messageEl.style.fontStyle = 'italic';
            messageEl.style.color = 'var(--text-secondary)';
            messageEl.style.textAlign = 'center';
            messageEl.style.maxWidth = '100%';
            
            messageEl.innerHTML = `
                <div class="message-text">${text}</div>
            `;
            
            chatContainer.appendChild(messageEl);
            scrollToBottom();
        }

        function handleTyping() {
            if (!isTyping) {
                isTyping = true;
                socket.emit('typing_start', { 
                    pin: currentPin,
                    userName: currentUserName
                });
            }
            
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                isTyping = false;
                socket.emit('typing_stop', { 
                    pin: currentPin,
                    userName: currentUserName
                });
            }, 1000);
        }

        function renderEmojiPicker() {
            emojis.forEach(emoji => {
                const emojiOption = document.createElement('div');
                emojiOption.className = 'emoji-option';
                emojiOption.textContent = emoji;
                emojiOption.addEventListener('click', () => {
                    insertEmoji(emoji);
                    toggleEmojiPicker();
                });
                emojiPicker.appendChild(emojiOption);
            });
        }

        function toggleEmojiPicker() {
            emojiPicker.classList.toggle('show');
        }

        function insertEmoji(emoji) {
            const cursorPos = messageInput.selectionStart;
            const textBefore = messageInput.value.substring(0, cursorPos);
            const textAfter = messageInput.value.substring(cursorPos);
            
            messageInput.value = textBefore + emoji + textAfter;
            messageInput.focus();
            messageInput.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
            
            autoResizeTextarea(messageInput);
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function setupMessageInput() {
            // Close emoji picker when clicking outside
            document.addEventListener('click', function(e) {
                if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
                    emojiPicker.classList.remove('show');
                }
            });
        }

        function generateMessageId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function showSettings() {
            settingsModal.classList.add('active');
            // Request current users when settings is opened
            socket.emit('get_current_users', { pin: currentPin });
            // Load statistics
            loadAppStatistics();
        }

        function hideSettings() {
            settingsModal.classList.remove('active');
        }

        function showLeaveConfirm() {
            if (confirm('Are you sure you want to leave this chat? You can rejoin later with the same PIN.')) {
                leaveRoom();
            }
        }

        function changeTheme(theme, broadcast = true) {
            // Update active theme button
            themeOptions.forEach(option => {
                option.classList.remove('active');
                if (option.getAttribute('data-theme') === theme) {
                    option.classList.add('active');
                }
            });
            
            // Apply theme
            document.body.setAttribute('data-theme', theme);
            currentTheme = theme;
            
            // Save to localStorage
            localStorage.setItem('chithi-theme', theme);
            
            // Broadcast to other users in the room
            if (broadcast && currentPin) {
                socket.emit('change_theme', {
                    pin: currentPin,
                    theme: theme
                });
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('chithi-theme') || 'default';
            changeTheme(savedTheme, false);
        }

        function deleteRoom() {
            if (confirm('Are you sure you want to delete this room? This will clear the chat history for all users.')) {
                socket.emit('delete_room', { pin: currentPin });
                // Clear local storage for this room
                localStorage.removeItem(`chithi-history-${currentPin}`);
                hideSettings();
            }
        }

        function leaveRoom() {
            // Clear user session
            localStorage.removeItem('chithi-pin');
            localStorage.removeItem('chithi-username');
            
            // Leave the room via socket
            socket.emit('leave_room', { pin: currentPin });
            
            // Reset UI
            resetChat();
            hideSettings();
        }

        function resetChat() {
            // Clear chat container except the first welcome message
            const welcomeMessage = chatContainer.querySelector('.message:first-child');
            chatContainer.innerHTML = '';
            if (welcomeMessage) {
                chatContainer.appendChild(welcomeMessage);
            }
            
            // Reset chat history
            chatHistory = [];
            
            // Reset UI state
            chatScreen.classList.add('hidden');
            joinScreen.classList.remove('hidden');
            settingsBtn.classList.add('hidden');
            leaveChatBtn.classList.add('hidden');
            userCount.classList.add('hidden');
            
            // Clear inputs
            userNameInput.value = '';
            clearPin();
            
            // Reset PIN display
            currentPinDisplay.textContent = '----';
            
            // Reset current state
            currentPin = '';
            currentUserName = '';
            currentReply = null;
            replyPreview.classList.add('hidden');
        }

        // Context menu function
        function showContextMenu(event, messageId, isOwnMessage) {
            contextMenu.setAttribute('data-message-id', messageId);
            
            // Show/hide unsend option based on ownership
            contextUnsendBtn.style.display = isOwnMessage ? 'flex' : 'none';
            
            contextMenu.style.left = event.clientX + 'px';
            contextMenu.style.top = event.clientY + 'px';
            contextMenu.classList.add('show');
        }

        function handleContextReply() {
            const messageId = contextMenu.getAttribute('data-message-id');
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                const sender = messageElement.querySelector('.message-sender').textContent;
                const text = messageElement.querySelector('.message-text').textContent;
                
                setCurrentReply({
                    messageId: messageId,
                    sender: sender,
                    text: text
                });
            }
            contextMenu.classList.remove('show');
        }

        function handleContextUnsend() {
            const messageId = contextMenu.getAttribute('data-message-id');
            if (confirm('Are you sure you want to unsend this message? This cannot be undone.')) {
                socket.emit('unsend_message', {
                    pin: currentPin,
                    messageId: messageId
                });
                
                // Remove from UI immediately
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    messageElement.remove();
                }
                
                // Remove from chat history
                chatHistory = chatHistory.filter(msg => msg.messageId !== messageId);
                localStorage.setItem(`chithi-history-${currentPin}`, JSON.stringify(chatHistory));
            }
            contextMenu.classList.remove('show');
        }

        function handleContextCopy() {
            const messageId = contextMenu.getAttribute('data-message-id');
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                const text = messageElement.querySelector('.message-text').textContent;
                navigator.clipboard.writeText(text).then(() => {
                    // Optional: Show copied notification
                });
            }
            contextMenu.classList.remove('show');
        }

        function setCurrentReply(reply) {
            currentReply = reply;
            replyPreviewSender.textContent = reply.sender;
            replyPreviewText.textContent = 
                reply.text.length > 50 ? reply.text.substring(0, 50) + '...' : reply.text;
            replyPreview.classList.remove('hidden');
            messageInput.focus();
        }

        function cancelReply() {
            currentReply = null;
            replyPreview.classList.add('hidden');
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
