<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chithi - Messaging App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 70vh;
        }

        .room-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #4facfe;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .chat-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 12px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .received {
            background: #f1f3f5;
            margin-right: auto;
        }

        .sent {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            margin-left: auto;
        }

        .message-header {
            font-size: 0.8em;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .users-list {
            padding: 10px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            max-height: 150px;
            overflow-y: auto;
        }

        .user-item {
            padding: 5px 10px;
            background: white;
            margin: 2px 0;
            border-radius: 5px;
            border-left: 3px solid #4facfe;
        }

        .notification-permission {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
        }

        .theme-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .theme-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .theme-option.active {
            border-color: #333;
        }

        .typing-indicator {
            font-style: italic;
            color: #666;
            padding: 5px 10px;
        }

        .message-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .reaction-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 2px 6px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 12px;
        }

        .unsend-btn {
            background: rgba(255, 0, 0, 0.1);
            color: #dc3545;
            border: none;
            padding: 2px 6px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 12px;
        }

        .status-indicator {
            font-size: 0.7em;
            opacity: 0.6;
            text-align: right;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ’Œ Chithi</h1>
            <p>Real-time messaging with push notifications</p>
        </div>

        <div class="chat-container">
            <div class="room-section">
                <div class="input-group">
                    <input type="text" id="userNameInput" placeholder="Enter your name" maxlength="20">
                    <input type="text" id="roomPinInput" placeholder="Enter room PIN" maxlength="6">
                    <button onclick="joinRoom()" id="joinBtn">Join Room</button>
                </div>
                
                <div id="notificationPermission" class="notification-permission" style="display: none;">
                    <p>Enable push notifications to get alerts when you receive messages!</p>
                    <button onclick="requestNotificationPermission()">Enable Notifications</button>
                </div>

                <div class="input-group" id="messageSection" style="display: none;">
                    <input type="text" id="messageInput" placeholder="Type your message..." maxlength="500">
                    <button onclick="sendMessage()" id="sendBtn">Send</button>
                </div>

                <div class="theme-selector" id="themeSection" style="display: none;">
                    <div class="theme-option" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);" onclick="changeTheme('blue')"></div>
                    <div class="theme-option" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);" onclick="changeTheme('green')"></div>
                    <div class="theme-option" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);" onclick="changeTheme('pink')"></div>
                    <div class="theme-option" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" onclick="changeTheme('purple')"></div>
                    <button onclick="deleteRoom()" style="background: #dc3545; margin-left: auto;">Delete Room</button>
                </div>
            </div>

            <div class="chat-area" id="chatArea">
                <div style="text-align: center; color: #666; padding: 40px;">
                    Join a room to start chatting!
                </div>
            </div>

            <div class="users-list" id="usersList" style="display: none;">
                <div style="font-weight: bold; margin-bottom: 5px;">Online Users:</div>
                <div id="usersContainer"></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket;
        let currentRoom = null;
        let currentUser = null;
        let pushSubscription = null;

        // Initialize service worker and push notifications
        async function initializePushNotifications() {
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                try {
                    // Register service worker
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('Service Worker registered');

                    // Check notification permission
                    if (Notification.permission === 'default') {
                        document.getElementById('notificationPermission').style.display = 'block';
                    }

                    // Get push subscription
                    pushSubscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: await getVAPIDPublicKey()
                    });

                    console.log('Push subscription obtained');

                } catch (error) {
                    console.error('Service Worker registration failed:', error);
                }
            }
        }

        // Get VAPID public key from server
        async function getVAPIDPublicKey() {
            const response = await fetch('/vapid-public-key');
            const data = await response.json();
            return urlBase64ToUint8Array(data.publicKey);
        }

        // Request notification permission
        async function requestNotificationPermission() {
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                document.getElementById('notificationPermission').style.display = 'none';
                console.log('Notification permission granted');
            }
        }

        // Utility function to convert base64 string to Uint8Array
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');

            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);

            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        function joinRoom() {
            const userName = document.getElementById('userNameInput').value.trim();
            const roomPin = document.getElementById('roomPinInput').value.trim();

            if (!userName || !roomPin) {
                alert('Please enter both name and room PIN');
                return;
            }

            if (roomPin.length !== 6) {
                alert('Room PIN must be 6 digits');
                return;
            }

            // Initialize socket connection
            socket = io();

            // Set up event listeners
            setupSocketListeners();

            // Join room
            socket.emit('join_room', {
                pin: roomPin,
                userName: userName
            });

            currentRoom = roomPin;
            currentUser = userName;

            // Update UI
            document.getElementById('userNameInput').disabled = true;
            document.getElementById('roomPinInput').disabled = true;
            document.getElementById('joinBtn').disabled = true;
            document.getElementById('messageSection').style.display = 'flex';
            document.getElementById('themeSection').style.display = 'flex';
            document.getElementById('usersList').style.display = 'block';

            // Register push subscription if available
            if (pushSubscription && socket) {
                socket.emit('register_push', { subscription: pushSubscription });
            }
        }

        function setupSocketListeners() {
            // Chat history
            socket.on('chat_history', (data) => {
                const chatArea = document.getElementById('chatArea');
                chatArea.innerHTML = '';
                data.messages.forEach(msg => {
                    addMessageToChat(msg, false);
                });
            });

            // New message
            socket.on('message', (data) => {
                addMessageToChat({
                    ...data,
                    type: 'received'
                }, true);
            });

            // User joined/left notifications
            socket.on('user_joined', (data) => {
                addSystemMessage(`${data.userName} joined the chat`);
            });

            socket.on('user_left', (data) => {
                addSystemMessage(`${data.userName} left the chat`);
            });

            // User count update
            socket.on('user_count_update', (data) => {
                console.log(`Users in room: ${data.count}`);
            });

            // Current users list
            socket.on('current_users', (data) => {
                const usersContainer = document.getElementById('usersContainer');
                usersContainer.innerHTML = '';
                data.users.forEach(user => {
                    const userElement = document.createElement('div');
                    userElement.className = 'user-item';
                    userElement.textContent = user.userName;
                    usersContainer.appendChild(userElement);
                });
            });

            // Theme change
            socket.on('theme_changed', (data) => {
                document.body.style.background = data.theme;
            });

            // Message reactions
            socket.on('message_reaction', (data) => {
                // Implement reaction display logic
                console.log('Reaction received:', data);
            });

            // Message unsent
            socket.on('message_unsent', (data) => {
                const messageElement = document.querySelector(`[data-message-id="${data.messageId}"]`);
                if (messageElement) {
                    messageElement.remove();
                }
            });

            // Room deleted
            socket.on('room_deleted', () => {
                alert('Room has been deleted by the owner');
                location.reload();
            });

            // Typing indicators
            socket.on('typing_start', (data) => {
                showTypingIndicator(data.userName);
            });

            socket.on('typing_stop', () => {
                hideTypingIndicator();
            });

            // Message status updates
            socket.on('message_status_update', (data) => {
                updateMessageStatus(data.messageId, data.status);
            });
        }

        function addMessageToChat(messageData, shouldScroll = true) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${messageData.type === 'sent' ? 'sent' : 'received'}`;
            messageDiv.setAttribute('data-message-id', messageData.messageId);

            const messageHeader = document.createElement('div');
            messageHeader.className = 'message-header';
            messageHeader.textContent = `${messageData.sender} â€¢ ${new Date(messageData.timestamp).toLocaleTimeString()}`;

            const messageBody = document.createElement('div');
            messageBody.textContent = messageData.message;

            messageDiv.appendChild(messageHeader);
            messageDiv.appendChild(messageBody);

            // Add message actions for sent messages
            if (messageData.type === 'sent') {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                
                const unsendBtn = document.createElement('button');
                unsendBtn.className = 'unsend-btn';
                unsendBtn.textContent = 'Unsend';
                unsendBtn.onclick = () => unsendMessage(messageData.messageId);
                
                const statusDiv = document.createElement('div');
                statusDiv.className = 'status-indicator';
                statusDiv.id = `status-${messageData.messageId}`;
                statusDiv.textContent = 'Sent';
                
                actionsDiv.appendChild(unsendBtn);
                messageDiv.appendChild(actionsDiv);
                messageDiv.appendChild(statusDiv);
            }

            chatArea.appendChild(messageDiv);

            if (shouldScroll) {
                chatArea.scrollTop = chatArea.scrollHeight;
            }
        }

        function addSystemMessage(text) {
            const chatArea = document.getElementById('chatArea');
            const systemMsg = document.createElement('div');
            systemMsg.style.textAlign = 'center';
            systemMsg.style.color = '#666';
            systemMsg.style.fontStyle = 'italic';
            systemMsg.style.padding = '10px';
            systemMsg.textContent = text;
            chatArea.appendChild(systemMsg);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message || !socket) return;

            const messageData = {
                pin: currentRoom,
                message: message,
                timestamp: Date.now(),
                messageId: generateMessageId(),
                sender: currentUser
            };

            // Add message to chat immediately
            addMessageToChat({
                ...messageData,
                type: 'sent'
            }, true);

            // Send to server
            socket.emit('send_message', messageData);

            // Clear input
            messageInput.value = '';
        }

        function unsendMessage(messageId) {
            if (socket && currentRoom) {
                socket.emit('unsend_message', {
                    pin: currentRoom,
                    messageId: messageId
                });
            }
        }

        function changeTheme(theme) {
            const themes = {
                blue: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                green: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                pink: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                purple: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
            };

            document.body.style.background = themes[theme];
            
            if (socket && currentRoom) {
                socket.emit('change_theme', {
                    pin: currentRoom,
                    theme: themes[theme]
                });
            }
        }

        function deleteRoom() {
            if (confirm('Are you sure you want to delete this room? This action cannot be undone.')) {
                socket.emit('delete_room', { pin: currentRoom });
            }
        }

        function generateMessageId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function updateMessageStatus(messageId, status) {
            const statusElement = document.getElementById(`status-${messageId}`);
            if (statusElement) {
                statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            }
        }

        // Typing indicators
        let typingTimer;
        const messageInput = document.getElementById('messageInput');
        
        if (messageInput) {
            messageInput.addEventListener('input', () => {
                if (socket && currentRoom) {
                    socket.emit('typing_start', {
                        pin: currentRoom,
                        userName: currentUser
                    });

                    clearTimeout(typingTimer);
                    typingTimer = setTimeout(() => {
                        socket.emit('typing_stop', { pin: currentRoom });
                    }, 1000);
                }
            });
        }

        function showTypingIndicator(userName) {
            // Implement typing indicator UI
        }

        function hideTypingIndicator() {
            // Hide typing indicator
        }

        // Enter key to send message
        document.getElementById('messageInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Initialize push notifications when page loads
        document.addEventListener('DOMContentLoaded', initializePushNotifications);
    </script>
</body>
</html>
